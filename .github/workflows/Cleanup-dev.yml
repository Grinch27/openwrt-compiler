name: Cleanup Release and Tag (Dev)

on:
  workflow_dispatch:
    inputs:
      keyword:
        description: "关键字，用于匹配需要删除的 release 和 tag"
        required: true
        default: "6.6.60"

run-name: Release and Tag - ${{ inputs.keyword }}

jobs:
  delete:
    name: ${{ inputs.keyword }}
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt-get -y update && sudo apt-get -y install gh

      - name: Auth with GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Delete releases (and tags) with keyword
        run: |
          # 列出所有 release（含 tag），用 grep 过滤出包含关键字的行
          # 其中 releaseName 就是 release 的 tagName
          for releaseName in $(
            gh release list --repo "$GITHUB_REPOSITORY" --limit 100 \
            | grep "${{ inputs.keyword }}" \
            | awk '{print $1}'
          ); do
            echo "Deleting release (and tag): $releaseName"
            # gh release delete <tag> 命令会同时删除该 release 及其 tag
            gh release delete "${releaseName}" --repo "$GITHUB_REPOSITORY" -y
          done